<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Playlist Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
        }
        button {
            background: #1DB954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1ed760;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }
        .success {
            background: rgba(46, 204, 113, 0.2);
            border-left: 4px solid #2ecc71;
        }
        .error {
            background: rgba(231, 76, 60, 0.2);
            border-left: 4px solid #e74c3c;
        }
        .info {
            background: rgba(52, 152, 219, 0.2);
            border-left: 4px solid #3498db;
        }
        .playlist-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .playlist-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .playlist-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .playlist-id {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Spotify Playlist Tester</h1>
        
        <div class="form-group">
            <label for="searchQuery">Search for Playlists:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="searchQuery" placeholder="e.g., 'lofi hip hop', 'deep focus', 'study music'" style="flex: 1;">
                <button onclick="searchPlaylists()" style="width: auto;">üîç Search</button>
            </div>
        </div>
        
        <div id="searchResults" style="margin-top: 15px;"></div>
        
        <div class="form-group">
            <label for="playlistId">Playlist ID to Test:</label>
            <input type="text" id="playlistId" placeholder="Enter 22-character Spotify playlist ID" maxlength="22">
        </div>
        
        <div class="form-group">
            <label for="domain">Domain to Map:</label>
            <select id="domain">
                <option value="">Select a domain...</option>
                <option value="amazon.com">Amazon</option>
                <option value="ebay.com">eBay</option>
                <option value="cnn.com">CNN</option>
                <option value="bbc.com">BBC</option>
                <option value="nytimes.com">New York Times</option>
                <option value="reddit.com">Reddit</option>
                <option value="youtube.com">YouTube</option>
                <option value="github.com">GitHub</option>
                <option value="stackoverflow.com">Stack Overflow</option>
                <option value="medium.com">Medium</option>
                <option value="default">Default</option>
            </select>
        </div>
        
        <div style="text-align: center;">
            <button onclick="validatePlaylist()">üîç Validate Playlist</button>
            <button onclick="updateMapping()" id="updateBtn" disabled>üìù Update Mapping</button>
            <button onclick="getMappings()">üìã View All Mappings</button>
        </div>
        
        <div id="result"></div>
        
        <div id="mappings" class="playlist-info"></div>
    </div>

    <script>
        let currentPlaylistId = null;
        let currentDomain = null;

        async function searchPlaylists() {
            const query = document.getElementById('searchQuery').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query) {
                showResult('Please enter a search query', 'error');
                return;
            }
            
            try {
                const response = await sendMessage({ type: 'SEARCH_PLAYLISTS', query });
                
                if (response.success && response.playlists.length > 0) {
                    displaySearchResults(response.playlists);
                } else {
                    resultsDiv.innerHTML = '<div class="result info">No playlists found for your search.</div>';
                }
            } catch (error) {
                showResult(`‚ùå Search error: ${error.message}`, 'error');
            }
        }

        function displaySearchResults(playlists) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<h3>Search Results:</h3>';
            
            playlists.forEach(playlist => {
                const playlistDiv = document.createElement('div');
                playlistDiv.className = 'playlist-card';
                playlistDiv.innerHTML = `
                    <div class="playlist-name">${playlist.name}</div>
                    <div style="font-size: 12px; margin-bottom: 10px; opacity: 0.8;">
                        By: ${playlist.owner.display_name} ‚Ä¢ ${playlist.tracks.total} tracks
                    </div>
                    <div class="playlist-id">${playlist.id}</div>
                    <button onclick="selectPlaylist('${playlist.id}', '${playlist.name}')" style="margin-top: 10px; font-size: 12px;">
                        Use This Playlist
                    </button>
                `;
                resultsDiv.appendChild(playlistDiv);
            });
        }

        function selectPlaylist(playlistId, playlistName) {
            document.getElementById('playlistId').value = playlistId;
            showResult(`‚úÖ Selected: "${playlistName}"`, 'success');
            validatePlaylist(); // Automatically validate the selected playlist
        }

        async function validatePlaylist() {
            const playlistId = document.getElementById('playlistId').value.trim();
            const resultDiv = document.getElementById('result');
            const updateBtn = document.getElementById('updateBtn');
            
            if (!playlistId) {
                showResult('Please enter a playlist ID', 'error');
                return;
            }
            
            if (!/^[a-zA-Z0-9]{22}$/.test(playlistId)) {
                showResult('Invalid playlist ID format. Must be exactly 22 characters long and contain only letters and numbers.', 'error');
                return;
            }
            
            try {
                const response = await sendMessage({ type: 'VALIDATE_PLAYLIST', playlistId });
                
                if (response.success) {
                    currentPlaylistId = playlistId;
                    showResult(`‚úÖ Valid playlist: "${response.playlistName}"`, 'success');
                    updateBtn.disabled = false;
                } else {
                    showResult(`‚ùå Invalid playlist: ${response.error}`, 'error');
                    updateBtn.disabled = true;
                }
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
                updateBtn.disabled = true;
            }
        }

        async function updateMapping() {
            const domain = document.getElementById('domain').value;
            const resultDiv = document.getElementById('result');
            
            if (!domain) {
                showResult('Please select a domain', 'error');
                return;
            }
            
            if (!currentPlaylistId) {
                showResult('Please validate a playlist first', 'error');
                return;
            }
            
            try {
                const response = await sendMessage({ 
                    type: 'UPDATE_PLAYLIST_MAPPING', 
                    domain, 
                    playlistId: currentPlaylistId 
                });
                
                if (response.success) {
                    showResult(`‚úÖ Successfully mapped ${domain} to "${response.playlistName}"`, 'success');
                    currentDomain = domain;
                    getMappings(); // Refresh the mappings display
                } else {
                    showResult(`‚ùå Failed to update mapping: ${response.error}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function getMappings() {
            try {
                const response = await sendMessage({ type: 'GET_PLAYLIST_MAPPINGS' });
                
                if (response.success) {
                    displayMappings(response.mappings);
                } else {
                    showResult(`‚ùå Failed to get mappings: ${response.error}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function displayMappings(mappings) {
            const mappingsDiv = document.getElementById('mappings');
            mappingsDiv.innerHTML = '';
            
            Object.entries(mappings).forEach(([domain, playlistId]) => {
                const card = document.createElement('div');
                card.className = 'playlist-card';
                card.innerHTML = `
                    <div class="playlist-name">${domain}</div>
                    <div class="playlist-id">${playlistId}</div>
                `;
                mappingsDiv.appendChild(card);
            });
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        function sendMessage(message) {
            return new Promise((resolve, reject) => {
                chrome.runtime.sendMessage(message, (response) => {
                    if (chrome.runtime.lastError) {
                        reject(new Error(chrome.runtime.lastError.message));
                    } else if (!response) {
                        reject(new Error('No response received'));
                    } else {
                        resolve(response);
                    }
                });
            });
        }

        // Load current mappings on page load
        document.addEventListener('DOMContentLoaded', () => {
            getMappings();
        });
    </script>
</body>
</html>
